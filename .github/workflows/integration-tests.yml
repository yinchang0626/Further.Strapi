name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  integration-tests:
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'etc/strapi-integration-test/package-lock.json'
        
    - name: Cache .NET packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
          
    - name: Install Node.js dependencies
      working-directory: etc/strapi-integration-test
      run: npm ci
      
    - name: Install Coverage Tools
      run: |
        dotnet tool install --global dotnet-reportgenerator-globaltool
      shell: pwsh
      
    - name: Run Integration Tests
      run: |
        # å•Ÿç”¨è¦†è“‹ç‡æ”¶é›†
        $env:ENABLE_COVERAGE = "true"
        & ".\etc\run-integration-tests.ps1"
      shell: pwsh
      
    - name: Generate Coverage Report
      if: always()
      run: |
        if (Test-Path "coverage.cobertura.xml") {
          reportgenerator "-reports:coverage.cobertura.xml" "-targetdir:coverage-report" "-reporttypes:Html;Badges;JsonSummary"
          Write-Host "âœ… Coverage report generated"
          
          # è®€å–è¦†è“‹ç‡æ•¸æ“š
          if (Test-Path "coverage-report/Summary.json") {
            $summary = Get-Content "coverage-report/Summary.json" | ConvertFrom-Json
            $lineCoverage = $summary.summary.linecoverage
            Write-Host "ğŸ“Š Line Coverage: $lineCoverage%"
            
            # è¨­å®š GitHub Actions output
            echo "COVERAGE_PERCENTAGE=$lineCoverage" >> $env:GITHUB_OUTPUT
          }
        } else {
          Write-Host "âš ï¸ No coverage file found"
        }
      shell: pwsh
      id: coverage
      
    - name: Upload Coverage to Codecov
      if: always()
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.cobertura.xml
        flags: integration
        name: codecov-integration-tests
        fail_ci_if_error: false
        verbose: true
        token: ${{ secrets.CODECOV_TOKEN }}  # éœ€è¦åœ¨ GitHub Secrets ä¸­è¨­å®š
        
    - name: Upload Test Results (Always)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ github.run_number }}
        path: |
          TestResults/
          coverage.cobertura.xml
          coverage-report/
        retention-days: 30
        
    - name: Publish Test Results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: .NET Tests
        path: TestResults/*.trx
        reporter: dotnet-trx
        fail-on-error: false
          
    - name: Comment Coverage on PR
      if: github.event_name == 'pull_request' && always() && steps.coverage.outputs.COVERAGE_PERCENTAGE
      uses: actions/github-script@v7
      with:
        script: |
          const coverage = '${{ steps.coverage.outputs.COVERAGE_PERCENTAGE }}';
          const coverageFloat = parseFloat(coverage);
          let coverageEmoji = 'ğŸ”´';
          if (coverageFloat >= 80) coverageEmoji = 'ğŸŸ¢';
          else if (coverageFloat >= 60) coverageEmoji = 'ğŸŸ¡';
          
          const body = `## ğŸ“Š Test Coverage Report ${coverageEmoji}
          
          **Line Coverage:** ${coverage}%
          
          ${coverageFloat >= 80 ? 'âœ… Great coverage!' : 
            coverageFloat >= 60 ? 'âš ï¸ Coverage could be improved' : 
            'âŒ Low coverage - consider adding more tests'}
          
          [ğŸ“‹ View detailed coverage report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
          
    - name: Coverage Badge Info
      if: always() && steps.coverage.outputs.COVERAGE_PERCENTAGE
      run: |
        $coverage = "${{ steps.coverage.outputs.COVERAGE_PERCENTAGE }}"
        $color = if ([float]$coverage -ge 80) { "green" } elseif ([float]$coverage -ge 60) { "yellow" } else { "red" }
        
        # å‰µå»ºå¾½ç«  URL (ä½¿ç”¨ shields.io - ä¸éœ€è¦ Gist)
        $badgeUrl = "https://img.shields.io/badge/Coverage-${coverage}%25-${color}"
        Write-Host "ğŸ† Coverage Badge URL: $badgeUrl"
        Write-Host "ğŸ“ æ‚¨å¯ä»¥åœ¨ README.md ä¸­ä½¿ç”¨é€™å€‹ URL ä¾†é¡¯ç¤ºå‹•æ…‹è¦†è“‹ç‡"
        Write-Host "ğŸ’¡ æˆ–è€…ä½¿ç”¨ Codecov çš„å®˜æ–¹å¾½ç« ï¼šhttps://codecov.io/gh/fs-tw/Further.LiveKit/branch/Further.Strapi/graph/badge.svg"
      shell: pwsh