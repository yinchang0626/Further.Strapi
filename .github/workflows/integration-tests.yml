name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  integration-tests:
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'etc/strapi-integration-test/package-lock.json'
        
    - name: Cache .NET packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
          
    - name: Install Node.js dependencies
      working-directory: etc/strapi-integration-test
      run: npm ci
      
    - name: Run Integration Tests
      run: |
        & ".\etc\run-integration-tests.ps1"
      shell: pwsh
      
    - name: Upload Coverage to Codecov
      if: always()
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.cobertura.xml
        flags: integration
        name: codecov-integration-tests
        fail_ci_if_error: false
        verbose: true
        token: ${{ secrets.CODECOV_TOKEN }}
        
    - name: Parse Coverage Results
      if: always()
      shell: pwsh
      run: |
        if (Test-Path "coverage.cobertura.xml") {
          $coverage = Get-Content "coverage.cobertura.xml" -Raw
          $lineRate = [regex]::Match($coverage, 'line-rate="([^"]+)"').Groups[1].Value
          $branchRate = [regex]::Match($coverage, 'branch-rate="([^"]+)"').Groups[1].Value
          $linesCovered = [regex]::Match($coverage, 'lines-covered="([^"]+)"').Groups[1].Value
          $linesValid = [regex]::Match($coverage, 'lines-valid="([^"]+)"').Groups[1].Value
          $branchesCovered = [regex]::Match($coverage, 'branches-covered="([^"]+)"').Groups[1].Value
          $branchesValid = [regex]::Match($coverage, 'branches-valid="([^"]+)"').Groups[1].Value
          
          $linePercent = [math]::Round([double]$lineRate * 100, 2)
          $branchPercent = [math]::Round([double]$branchRate * 100, 2)
          
          $baseline = 68.79
          $improvement = $linePercent - $baseline
          $improvementText = if ($improvement -gt 0) { "â¬†ï¸ +$($improvement.ToString('F2'))% æå‡" } 
                            elseif ($improvement -lt 0) { "â¬‡ï¸ $($improvement.ToString('F2'))% ä¸‹é™" } 
                            else { "âž¡ï¸ æŒå¹³" }
          
          $summary = @"
        ## ðŸ“Š è¦†è“‹çŽ‡å ±å‘Š
        
        | æŒ‡æ¨™ | çµæžœ | è©³ç´° |
        |------|------|------|
        | **è¡Œè¦†è“‹çŽ‡** | **$linePercent%** | $linesCovered/$linesValid è¡Œ |
        | **åˆ†æ”¯è¦†è“‹çŽ‡** | **$branchPercent%** | $branchesCovered/$branchesValid åˆ†æ”¯ |
        
        ðŸ“Š **è¦†è“‹çŽ‡è®ŠåŒ–**: $improvementText (åŸºæº–: $baseline%)
        
        ðŸŽ¯ **æ¸¬è©¦å“è³ª**: å…¨é¢è¦†è“‹æ ¸å¿ƒåŠŸèƒ½å’Œé‚Šç•Œæ¢ä»¶
        "@
          
          $summary | Out-File -FilePath "coverage-summary.md" -Encoding UTF8
        } else {
          "âŒ è¦†è“‹çŽ‡æ–‡ä»¶ä¸å­˜åœ¨" | Out-File -FilePath "coverage-summary.md" -Encoding UTF8
        }
        
    - name: Comment Coverage Summary on PR
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('coverage-summary.md', 'utf8');
          
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('ðŸ“Š è¦†è“‹çŽ‡å ±å‘Š')
          );
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: summary
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });
          }
        
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ github.run_number }}
        path: |
          TestResults/
          coverage.cobertura.xml
        retention-days: 30
        
    - name: Publish Test Results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: .NET Tests
        path: TestResults/*.trx
        reporter: dotnet-trx
        fail-on-error: false