name: "ðŸ§ª Quality Gate (CI)"

on:
  pull_request:
    branches: [ main ]      # åªç®¡ PRï¼Œä¸ç®¡åˆ¥çš„
  workflow_dispatch:        # æ‰‹å‹•è§¸ç™¼

jobs:
  complete-testing:
    name: "ðŸ”¬ Complete Testing Pipeline"
    runs-on: ubuntu-latest
    
    steps:
    - name: "ðŸ“¥ Get the code"
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha || github.sha }}
    
    - name: "âš™ï¸ Setup .NET"
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: "ðŸ”§ Restore dependencies"
      run: dotnet restore
      
    - name: "ðŸ—ï¸ Build"
      run: dotnet build --no-restore --configuration Release

    # æ—¥æœ¬äºº SOPï¼šå®Œæ•´æº–å‚™ Strapi ç’°å¢ƒï¼Œæ…¢æ…¢ä¾†ä¸è¦æ€¥
    - name: "ðŸŸ¢ Setup Node.js"
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: etc/strapi-integration-test/package-lock.json
        
    - name: "ðŸ“¦ Install Strapi dependencies"
      working-directory: etc/strapi-integration-test
      run: |
        echo "ðŸ”§ Fixing dependency version conflicts..."
        # æª¢æŸ¥æ˜¯å¦æœ‰ç‰ˆæœ¬è¡çªï¼Œå¦‚æžœæœ‰å°±é‡æ–°ç”Ÿæˆ lock file
        if ! npm ci; then
          echo "âš ï¸ Lock file out of sync, regenerating..."
          rm -f package-lock.json
          npm install
          echo "âœ… Dependencies synchronized!"
        else
          echo "âœ… Dependencies installed successfully!"
        fi
      
    - name: "ðŸš€ Launch Strapi Environment"
      working-directory: etc/strapi-integration-test
      run: |
        echo "ðŸŒ Creating pristine Strapi test environment..."
        echo "â° Japanese SOP: We wait as long as it takes for Strapi to be ready!"
        cat > .env << EOF
        HOST=0.0.0.0
        PORT=1337
        APP_KEYS=$(openssl rand -base64 32),$(openssl rand -base64 32)
        API_TOKEN_SALT=$(openssl rand -base64 32)
        ADMIN_JWT_SECRET=$(openssl rand -base64 32)
        TRANSFER_TOKEN_SALT=$(openssl rand -base64 32)
        JWT_SECRET=$(openssl rand -base64 32)
        DATABASE_CLIENT=sqlite
        DATABASE_FILENAME=.tmp/data.db
        EOF
        
        npm run build
        npm run start &
        
        echo "â³ Waiting patiently for Strapi to be fully operational..."
        timeout 300 bash -c 'until curl -f http://localhost:1337/admin; do echo "â° Still waiting..."; sleep 5; done'
        echo "âœ… Strapi environment ready! Perfect!"
        
    - name: "ðŸ”‘ Setup Strapi admin and API token (Node.js)"
      working-directory: etc/strapi-integration-test
      run: |
        echo "ðŸš€ Running Node.js CI setup script..."
        npm run setup-ci
        echo "âœ… Strapi CI setup completed!"
      
    - name: "ðŸ§ª Execute Complete Test Suite"
      run: |
        echo "ðŸ”¬ Running ALL tests - no classification needed, just thorough testing!"
        echo "ðŸŒ This includes ABP tests, Strapi integration tests, everything!"
        dotnet test --no-build --configuration Release --verbosity detailed
        echo "âœ… All tests completed - comprehensive validation done!"
      env:
        ASPNETCORE_ENVIRONMENT: Test

    # å®Œæ•´è¦†è“‹çŽ‡åˆ†æž
    - name: "ðŸ“Š Generate Complete Test Coverage Report"
      run: |
        echo "ðŸ“ˆ Running complete test suite with coverage analysis..."
        dotnet test --configuration Release --verbosity minimal \
          --collect:"XPlat Code Coverage" \
          --results-directory ./final-coverage \
          --logger "console;verbosity=minimal"
        echo "âœ… Complete coverage report generated!"
      env:
        ASPNETCORE_ENVIRONMENT: Test

    - name: "ðŸš€ Upload Final Coverage to Codecov"
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        directory: ./final-coverage
        flags: complete
        name: "Complete Test Coverage"
        fail_ci_if_error: false