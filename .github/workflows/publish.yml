name: "âš¡ CD (Continuous Deployment)"

on:
  push:
    branches:
      - main                # åªç®¡ mainï¼Œå…¶ä»–ä¸é—œæˆ‘äº‹
    paths:
      - 'common.props'      # ç‰ˆæœ¬è®Šäº†å°±ç™¼å¸ƒï¼Œç°¡å–®
  workflow_dispatch:        # æƒ³ç™¼å°±ç™¼

jobs:
  rapid-publish:
    name: "âš¡ Speed Demon Release"
    runs-on: ubuntu-latest
    
    steps:
    - name: "ğŸ“¥ Grab the code"
      uses: actions/checkout@v4
      
    - name: "âš™ï¸ Setup .NET"
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: "ğŸ” Detect version"
      id: getVersion
      run: |
        VERSION=$(grep -oP '(?<=<Version>)[^<]+' common.props)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ¯ Target version: $VERSION"

    - name: "ğŸ” Check if already shipped"
      uses: mukunku/tag-exists-action@v1.2.0
      id: checkTag
      with:
        tag: v${{ steps.getVersion.outputs.version }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: "ğŸš« Skip if duplicate"
      if: steps.checkTag.outputs.exists == 'true'
      run: |
        echo "âš ï¸ Version v${{ steps.getVersion.outputs.version }} already published. Nothing to do."
        exit 0

    - name: "ğŸ”§ Restore packages"
      if: steps.checkTag.outputs.exists == 'false'
      run: dotnet restore

    - name: "ğŸ—ï¸ Build release"
      if: steps.checkTag.outputs.exists == 'false'
      run: dotnet build --no-restore --configuration Release

    - name: "âš¡ Lightning-fast validation"
      if: steps.checkTag.outputs.exists == 'false'
      run: |
        echo "âš¡ Running minimal validation (publish mode)..."
        echo "ğŸ’­ Full testing already done by someone else, I just verify basics"
        dotnet test --no-build --configuration Release --verbosity minimal --filter "Category!=StrapiRealIntegration"
        echo "âœ… Validation passed! Ready for launch!"

    - name: "ğŸ“¦ Package for shipping"
      if: steps.checkTag.outputs.exists == 'false'
      run: dotnet pack --no-build --configuration Release --output ./shipping/

    - name: "ğŸ§¹ Clean up non-essential packages"
      if: steps.checkTag.outputs.exists == 'false'
      run: |
        cd ./shipping
        # Remove junk packages
        rm -f *.Tests.* *.TestBase.* *.Host.* *.HttpApi.Host.* *.Web.* *.Blazor.* *.ConsoleTestApp.*
        echo "ğŸ“¦ Packages ready for shipping:"
        ls -la *.nupkg

    - name: "ğŸš€ Launch to NuGet.org"
      if: steps.checkTag.outputs.exists == 'false'
      run: |
        for package in ./shipping/*.nupkg; do
          echo "ğŸš€ Launching $package to NuGet.org..."
          dotnet nuget push "$package" \
            --source "https://api.nuget.org/v3/index.json" \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --skip-duplicate
        done
        
        # Push symbol packages separately
        for symbolpackage in ./shipping/*.snupkg; do
          if [ -f "$symbolpackage" ]; then
            echo "ğŸ” Launching symbols $symbolpackage to NuGet.org..."
            dotnet nuget push "$symbolpackage" \
              --source "https://api.nuget.org/v3/index.json" \
              --api-key ${{ secrets.NUGET_API_KEY }} \
              --skip-duplicate
          fi
        done

    - name: "ğŸ·ï¸ Create version tag"
      if: steps.checkTag.outputs.exists == 'false'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.git.createRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: 'refs/tags/v${{ steps.getVersion.outputs.version }}',
            sha: context.sha
          })

    - name: "ğŸ‰ Create release announcement"
      if: steps.checkTag.outputs.exists == 'false'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.getVersion.outputs.version }}
        name: "ğŸš€ Further.Strapi v${{ steps.getVersion.outputs.version }}"
        body: |
          ## âš¡ Further.Strapi v${{ steps.getVersion.outputs.version }}
          
          **Lightning-fast release deployed!** ğŸš€
          
          ### ï¿½ Installation
          ```bash
          dotnet add package Further.Strapi
          ```
          
          ### âš¡ Release Speed
          - âœ… Rapid validation: Passed
          - âœ… Package creation: Completed
          - âœ… NuGet.org deployment: Done
          
          ### ğŸ“Š Quality Metrics
          - Testing coverage: See [Codecov](https://codecov.io/gh/yinchang0626/Further.Strapi)
          - Integration tests: Handled by PR workflow
          
          ### ï¿½ Resources
          - [Documentation](https://github.com/yinchang0626/Further.Strapi)
          - [API Examples](https://github.com/yinchang0626/Further.Strapi#quick-start)
          - [Changelog](https://github.com/yinchang0626/Further.Strapi/blob/main/CHANGELOG.md)
          
          ---
          *Released by the Lightning Publish system* âš¡
        files: ./shipping/*.nupkg
        draft: false
        prerelease: false