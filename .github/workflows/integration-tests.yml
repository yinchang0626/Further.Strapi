name: "ğŸ§ª CI (Continuous Integration)"

on:
  push:
    branches: [ main ]        # åªæœ‰ main åˆ†æ”¯
  pull_request:
    branches: [ main ]        # å° main çš„ PR
  workflow_dispatch:        # æƒ³ç™¼å°±ç™¼

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  integration-tests:
    name: "ğŸ§ª Quality Guardian"
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
    - name: "ğŸ“¥ Grab the code"
      uses: actions/checkout@v4
      
    - name: "âš™ï¸ Setup .NET"
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: "ğŸŸ¢ Setup Node.js"
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'etc/strapi-integration-test/package-lock.json'
        
    - name: "ğŸ’¾ Cache .NET packages"
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
          
    - name: "ğŸ“¦ Install Node.js dependencies"
      working-directory: etc/strapi-integration-test
      run: npm ci
      
    - name: "ğŸ§ª Run Integration Tests"
      run: |
        & ".\etc\run-integration-tests.ps1"
      shell: pwsh
      
    - name: "ğŸ“Š Upload Coverage to Codecov"
      if: always()
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.cobertura.xml
        flags: integration
        name: codecov-integration-tests
        fail_ci_if_error: false
        verbose: true
        token: ${{ secrets.CODECOV_TOKEN }}
        
    - name: "ğŸ“ˆ Parse Coverage Results"
      if: always()
      shell: pwsh
      run: |
        # è§£ææ¸¬è©¦çµæœ
        $testResults = @{
          Total = 0
          Passed = 0
          Failed = 0
          Skipped = 0
        }
        
        if (Test-Path "TestResults") {
          $trxFiles = Get-ChildItem "TestResults" -Filter "*.trx" -Recurse
          foreach ($trxFile in $trxFiles) {
            $trxContent = Get-Content $trxFile.FullName -Raw
            $trxXml = [xml]$trxContent
            
            if ($trxXml.TestRun.ResultSummary) {
              $summary = $trxXml.TestRun.ResultSummary
              $testResults.Total += [int]$summary.outcome.total
              $testResults.Passed += [int]$summary.outcome.passed
              $testResults.Failed += [int]$summary.outcome.failed
              if ($summary.outcome.notExecuted) {
                $testResults.Skipped += [int]$summary.outcome.notExecuted
              }
            }
          }
        }
        
        # è§£æè¦†è“‹ç‡çµæœ
        if (Test-Path "coverage.cobertura.xml") {
          $coverage = Get-Content "coverage.cobertura.xml" -Raw
          $lineRate = [regex]::Match($coverage, 'line-rate="([^"]+)"').Groups[1].Value
          $branchRate = [regex]::Match($coverage, 'branch-rate="([^"]+)"').Groups[1].Value
          $linesCovered = [regex]::Match($coverage, 'lines-covered="([^"]+)"').Groups[1].Value
          $linesValid = [regex]::Match($coverage, 'lines-valid="([^"]+)"').Groups[1].Value
          $branchesCovered = [regex]::Match($coverage, 'branches-covered="([^"]+)"').Groups[1].Value
          $branchesValid = [regex]::Match($coverage, 'branches-valid="([^"]+)"').Groups[1].Value
          
          $linePercent = [math]::Round([double]$lineRate * 100, 2)
          $branchPercent = [math]::Round([double]$branchRate * 100, 2)
          
          # æ¸¬è©¦ç‹€æ…‹ emoji
          $testIcon = if ($testResults.Failed -eq 0) { "âœ…" } else { "âŒ" }
          $coverageIcon = if ($linePercent -ge 80) { "ğŸŸ¢" } elseif ($linePercent -ge 60) { "ğŸŸ¡" } else { "ğŸ”´" }
          
          $summary = @"
        ## ğŸ§ª æ¸¬è©¦çµæœ
        
        | é …ç›® | çµæœ | è©³ç´° |
        |------|------|------|
        | **æ¸¬è©¦ç‹€æ…‹** | **$testIcon** | $($testResults.Passed) æˆåŠŸ, $($testResults.Failed) å¤±æ•—, $($testResults.Skipped) è·³é |
        | **ç¸½æ¸¬è©¦æ•¸** | **$($testResults.Total)** | å…±åŸ·è¡Œ $($testResults.Total) å€‹æ¸¬è©¦ |
        
        ## ğŸ“Š è¦†è“‹ç‡å ±å‘Š
        
        | æŒ‡æ¨™ | çµæœ | è©³ç´° |
        |------|------|------|
        | **è¡Œè¦†è“‹ç‡** | **$coverageIcon $linePercent%** | $linesCovered/$linesValid è¡Œ |
        | **åˆ†æ”¯è¦†è“‹ç‡** | **$branchPercent%** | $branchesCovered/$branchesValid åˆ†æ”¯ |
        
        ğŸ¯ **æ¸¬è©¦å“è³ª**: å…¨é¢è¦†è“‹æ ¸å¿ƒåŠŸèƒ½å’Œé‚Šç•Œæ¢ä»¶
        "@
          
          $summary | Out-File -FilePath "coverage-summary.md" -Encoding UTF8
        } else {
          # å¦‚æœæ²’æœ‰è¦†è“‹ç‡æ–‡ä»¶ï¼Œè‡³å°‘é¡¯ç¤ºæ¸¬è©¦çµæœ
          $testIcon = if ($testResults.Failed -eq 0) { "âœ…" } else { "âŒ" }
          
          $summary = @"
        ## ğŸ§ª æ¸¬è©¦çµæœ
        
        | é …ç›® | çµæœ | è©³ç´° |
        |------|------|------|
        | **æ¸¬è©¦ç‹€æ…‹** | **$testIcon** | $($testResults.Passed) æˆåŠŸ, $($testResults.Failed) å¤±æ•—, $($testResults.Skipped) è·³é |
        | **ç¸½æ¸¬è©¦æ•¸** | **$($testResults.Total)** | å…±åŸ·è¡Œ $($testResults.Total) å€‹æ¸¬è©¦ |
        
        âŒ è¦†è“‹ç‡æ–‡ä»¶ä¸å­˜åœ¨
        "@
          
          $summary | Out-File -FilePath "coverage-summary.md" -Encoding UTF8
        }
        
    - name: "ğŸ’¬ Comment Coverage Summary on PR"
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (!fs.existsSync('coverage-summary.md')) {
            console.log('âŒ è¦†è“‹ç‡å ±å‘Šæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³éç•™è¨€æ›´æ–°');
            return;
          }
          
          const summary = fs.readFileSync('coverage-summary.md', 'utf8');
          
          // å¦‚æœæ˜¯ PR äº‹ä»¶ï¼Œç›´æ¥è™•ç†
          if (context.eventName === 'pull_request') {
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              (comment.body.includes('ğŸ§ª æ¸¬è©¦çµæœ') || comment.body.includes('ğŸ“Š è¦†è“‹ç‡å ±å‘Š'))
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: summary
              });
              console.log('âœ… æ›´æ–°äº†ç¾æœ‰çš„è¦†è“‹ç‡ç•™è¨€');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
              console.log('âœ… å‰µå»ºäº†æ–°çš„è¦†è“‹ç‡ç•™è¨€');
            }
          }
          // å¦‚æœæ˜¯ push äº‹ä»¶ï¼Œæ‰¾åˆ°ç›¸é—œçš„ PR ä¸¦æ›´æ–°ç•™è¨€
          else if (context.eventName === 'push') {
            const branch = context.ref.replace('refs/heads/', '');
            console.log(`ğŸ” å°‹æ‰¾åˆ†æ”¯ ${branch} çš„é–‹æ”¾ PR...`);
            
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open'
            });
            
            if (prs.length === 0) {
              console.log(`â„¹ï¸ åˆ†æ”¯ ${branch} æ²’æœ‰é–‹æ”¾çš„ PRï¼Œè·³éç•™è¨€æ›´æ–°`);
              return;
            }
            
            for (const pr of prs) {
              console.log(`ğŸ¯ æ›´æ–° PR #${pr.number} çš„è¦†è“‹ç‡ç•™è¨€...`);
              
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
              });
              
              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && 
                (comment.body.includes('ğŸ§ª æ¸¬è©¦çµæœ') || comment.body.includes('ğŸ“Š è¦†è“‹ç‡å ±å‘Š'))
              );
              
              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: summary
                });
                console.log(`âœ… æ›´æ–°äº† PR #${pr.number} çš„è¦†è“‹ç‡ç•™è¨€`);
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: summary
                });
                console.log(`âœ… åœ¨ PR #${pr.number} å‰µå»ºäº†æ–°çš„è¦†è“‹ç‡ç•™è¨€`);
              }
            }
          }
          else {
            console.log(`â„¹ï¸ äº‹ä»¶é¡å‹ ${context.eventName} ä¸éœ€è¦æ›´æ–° PR ç•™è¨€`);
          }
        
    - name: "ğŸ“¤ Upload Test Results"
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ github.run_number }}
        path: |
          TestResults/
          coverage.cobertura.xml
        retention-days: 30
        
    - name: "ğŸ“‹ Publish Test Results"
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: .NET Tests
        path: TestResults/*.trx
        reporter: dotnet-trx
        fail-on-error: false